name: Validate that the example config.php has valid syntax for a specific PHP version
on:
  workflow_call:
    inputs:
      php-version:
        description: PHP version to validate against
        required: true
        type: string

jobs:
  validate-config-for-version:
    name: Validate for PHP ${{ inputs.php-version }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
      - name: Create symlinks for config.php includes
        run: |
          sudo mkdir -p /var/www/totara
          sudo ln -sf "$GITHUB_WORKSPACE/php/includes" /var/www/totara/includes
      - name: Set up PHP ${{ inputs.php-version }}
        uses: shivammathur/setup-php@c541c155eee45413f5b09a52248675b1a2575231 # v2.31.1
        with:
          php-version: ${{ inputs.php-version }}
      - name: Validate config.php syntax (PHP ${{ inputs.php-version }})
        run: php -l ./config.php && find ./php/includes -name '*.php' -exec php -l {} +
      - name: Check that required $CFG variables are defined (PHP ${{ inputs.php-version }})
        run: |
          php -r '
            define("CLI_SCRIPT", true);
            define("ABORT_AFTER_CONFIG", true);
            include "config.php";
            foreach (["dbhost", "dbtype", "dbuser", "dbpass", "dbname", "prefix", "wwwroot", "dataroot"] as $var) {
              if (!isset($CFG->{$var})) {
                fwrite(STDERR, "Missing \$CFG->{$var} from config.php (or from php/includes/) - is it commented out?\n");
                exit(1);
              }
            }
          '
